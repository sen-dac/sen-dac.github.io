<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>DMA 2 | SEN::DAC</title>
    <link rel="stylesheet" href="../style.css">
    <link rel="icon" href="../favicon.png" type="image/png">
</head>

<body>
<!-- サイト全体のタイトル リンクを指定しているので改めてテキストの色指定をしている-->
<h1><a href="../index.html" style="color: #00ff83; text-decoration: none;">SEN::DAC - Laboratory -</a></h1>

<!-- ページのタイトル -->
<h2>DMA "CPUを介さずデータ転送する魔法" 第2話</h2>
<img src="17081416074956232.png" alt="HD63450PS10" style="max-width: 100%; height: auto; display: block; margin: 0 auto;">

<br>
<div style="display: flex; justify-content: space-between;">
    <span><a href="../DMA_1_Z940/DMA_1_Z940.html"><< 前の記事へ</a></span>
    <span><a href="../DMA_3_Z976/DMA_3_Z976.html">次の記事へ >></a></span>
</div>

<h3>2024-03-13 投稿：</h3>

前回に引き続き、DMAに関する学習内容のアウトプットをさせていただきます。<br>
よろしければ、お付き合いください。(もうフリーレン様はどこかへ行きました)<br>
<br>

<h3>DMAC(63450)の外観と役割</h3>

X68000の中には "63450" というLSIが1個入っています。<br>
この投稿の表紙画像中央の部品で "HD63450PS10" と書かれたコイツです。<br>
(これはEXPERTの中にいました)<br>
<br>
第1話の表紙画像も見て下さい。<br>

<br>
<img src="17070073410588309.png" alt="HD63450CP10" style="max-width: 100%; height: auto; display: block; margin: 0 auto;">
<br>

こちらは形が異なりますが "HD63450CP10" と書いてあるコイツも同じものです。<br>
(これはCompactXVIの中にいました)<br>
<br>
これら "63450" は、DMAC(でぃーまっく) "ダイレクト・メモリ・アクセス・コントローラ" と呼ばれるモノです。<br>
<br>
彼らは、DMA(でぃーえむえー)転送をコントロールするハードウェア(LSI)として生まれてきました。<br>
<br>
色々なメーカーが、色々な名前の、色々と性能の違うDMACを作っていたりしますが、X68000に乗っているDMACは全て63450です。<br>
<br>
DMA転送とは、CPUを介さず"ダイレクト"に"メモリ"に"アクセス"してデータ転送を行う事をいいます。<br>
データのコピーを専用のハードウェアに丸投げできる訳ですね。<br>
<br>
なお、"X68000 Z"には、写真のような物体は入っておらず、ソフト的に再現(エミュレーション)されて本体に書き込まれています。<br>
<br>
イメージは大事なので、あえて63450という物体の写真を貼ってみた次第です。<br>
<br>

<h3>DMAC(63450)のチャンネル</h3>

1個の63450の中には4つのチャンネルがあります。<br>
それぞれのチャンネルは、X68000上で次のように使われています。<br>
<br>
・チャンネル#0 → フロッピーディスクの制御に接続<br>
<br>
・チャンネル#1 → ハードディスクの制御に接続<br>
<br>
・チャンネル#2 → 未使用(ユーザー解放)<br>
<br>
・チャンネル#3 → ADPCMの制御に接続<br>
<br>
X68000を創造した神の手により、既になんか色々とI/Oが接続されていますね。<br>
63450はメモリだけでなく、実はI/Oにもアクセスできる欲張りさんだったようです。<br>
しかし、何か特殊な事に挑まない限り、自前のプログラムがI/Oにアクセスする事は稀だと思われます。<br>
<br>
と、いう訳で、今はI/Oへのアクセスをバッサリ切り捨てて、メモリからメモリへの転送だけ考えます。<br>
メモリ→メモリ転送が可能なのは、"チャンネル#2"だけです。<br>
自ずと、これから使用するチャンネルが決まりましたね。<br>
以降はチャンネル#2に絞って話を進めます。<br>
<br>

<h3>DMAC(63450)の操作方法</h3
>
使用するチャンネルが決まったので、次はコレの操作方法について見ていきます。<br>
<br>
63450の内部には、"レジスタ"と呼ばれる8ビットとか、16ビットとか、32ビットとかの幅の空間があります。<br>
それぞれのレジスタには CSRだの、DCRだの、OCRだの、愛着が湧かない名前が付いています。<br>
<br>
更に各レジスタ内の各ビットにも COCとか、REQG、DIRなど、やはり愛着が湧かない名前が付いてます。<br>
これらビットに、DMACをどのように使いたいかの設定値を書き込んでいきます。<br>
("読む専" のレジスタ ( Read Onry属性とかR属性とか言われる ) もありますが)<br>
<br>
例えば、OCR(8ビット幅)というレジスタの中にあるSIZE(2ビット幅)というビットには"1回の転送サイズ"を指定します。<br>
<br>
ここに"00"を書き込めば、1回の転送が1バイトになり、"01"で1ワード(2バイト)、"10"で1ロングワード(4バイト)、"11"は未定義なのでパルプンテです。<br>
<br>
という具合で、この他にも色々なビットに色々な設定をしていく訳です。<br>
<br>
ところで、63450など外部にあるLSIの各レジスタに、どうやってアクセスするのか疑問に思いますよね？<br>
<br>
大丈夫です。X68000はアドレス空間上にメモリと他の様々なアレコレが共存する形でマウントされています。<br>
63450の各レジスタにもアドレスが割り当てられており、メモリ(変数)にアクセスするのと全く同じ感覚でアクセスできます。<br>
<br>
ちなみに、MPU(MC68000)の内部にもレジスタ(D0～D7,A0～A7,PC,SR)がいますが、今はコイツら無関係です。<br>
これ以降レジスタと言ったら、63450の内部にあるレジスタの事を言っています。<br>
<br>
各レジスタの詳細は、また後ほどに見ていく事にします。<br>
次の項からは、設定項目を一つ一つ見ていき、設定の指針を決めていきましょう。<br>
<br>

<h3>デュアルかシングルか</h3>

63450によるDMAのデータの流し方について、以下の2つのどちらかに決める必要があります。<br>
<br>
<b>① デュアルアドレスモード</b><br>
転送元と転送先の2つのアドレスを指定します。<br>
<br>
<b>② シングルアドレスモード</b><br>
アドレス指定は1つだけで、もう一方はACK信号(後述)の線が物理的に接続されたI/Oとなります。<br>
デュアルアドレスモードより転送速度が速いです。<br>
<br>
X68000では通常、"全てのチャンネル"がデュアルアドレスモードで動作するように設定されています。<br>
(チャンネル#2以外の接続先にはアドレスが割り当てられていると推測)<br>
<br>
あと、シングルアドレスモードは仕組み的にメモリからメモリへの転送ができません。<br>
今回はメモリ→メモリ転送しか行わない方針なので、必然的にデュアルアドレスモードを使うしかありません。<br>
<br>

<h3>2024-02-21 追記：</h3>

Inside X68000 P.43 DTYP(デバイスタイプ)の項に以下の文言を発見。<br>
"～X68000では基本的にシングルアドレスモードのサポートはうたっていませんから,～"<br>
確かに、SHARP公式のX68000サービスマニュアルを見てみると、何処にもシングルアドレスモードに関する記載はありません。<br>
<br>
X68000でDMA転送する場合は常にデュアルアドレスモード一択っぽいですね。<br>
63450は、別にX68000のためだけに作られたLSIではないと考えると、X68000的には使えない機能を持っている事に不思議は無いと思います。<br>
<br>
という訳で、DMACの設定値を決める際にはシングルアドレスモードに関わる設定は全て無効側に設定します。<br>
逆にデュアルアドレスモードに関わる設定は、全て有効側に設定します。<br>
<br>

<h3>DMAC(63450)から生えてるピン</h3>

再び、63450の写真を見ていただくと黒くて四角い石から銀色のピンがたくさん生えてますよね？<br>
これらのピンはX68000上の色々と大事な所につながっています。<br>
<br>
ほとんどのピンは通常気にする必要ありませんが、ほんの数本だけ知っておくべきピンがあります。<br>
名前と役割だけ知っていれば十分で、63450のどこから生えているか(何番ピンか)などは別に知る必要がありません。<br>
<br>
<b>・REQ0～REQ3(DMA転送要求信号)：DMAC←外部</b><br>
    63450の外部から「転送してくれ」という要求を受け取るピンです。<br>
    この要求を合図にDMA転送を開始する事ができます。<br>
    各チャンネルに存在していて、チャンネル#2ではREQ2となります。<br>
<br>
<b>・ACK0～ACK3(応答信号)：DMAC→外部</b><br>
    シングルアドレスモードの場合にのみ使います。<br>
    この信号をI/Oに送り「データを出力してくれ」と合図します。<br>
    各チャンネルに存在していて、チャンネル#2ではACK2となります。<br>
<br>
<b>・PCL0～PCL3(汎用入力信号)：DMAC←外部</b><br>
    設定により色々な事に使えるピンです。<br>
    各チャンネルに存在していて、チャンネル#2ではPCL2となります。<br>
<br>
<b>・DONE：DMAC←→外部</b><br>
    DMA要求を行ったI/Oデバイスが全データ転送完了した事を教えてれくるピンです。<br>
    1つの63450上に1つしかありません。<br>
<br>
面白いのが、DONE(どね？)以外は各チャンネル用のピンが存在している訳ですが、我らがチャンネル#2のヤツは、なんと！拡張スロットに接続されているという事です。<br>
SCSIボードとかMIDIボードとか色々と差し込むアレですね。<br>
<br>
さてここで、再びZの話になります。<br>
悲しい事に(？)、Zには拡張スロットがありません。<br>
このため、Z本体に何かとてつもない改造がされていない限りは、これらのピンを使う事はできません。<br>
(特にACKはシングルアドレスモード用の物なので、もともと使えません)<br>
<br>
DONEはFDDの制御に接続されていますが、今回の方針ではI/Oは触らないのでコレも使いません。<br>
<br>
という訳で、設定値を決める際、REQ2,ACK2,PCL2.DONEなどピンの話が絡む設定は、全て未使用を前提とした設定値になります。<br>
<br>

<h3>転送開始の合図</h3>

転送開始の合図は以下の３択です。<br>
<br>
<b>① 外部要求転送モード(REQが合図)</b><br>
<b>② オートリクエストモード</b><br>
<b>③ オートリクエストと外部要求転送(REQが合図)の組み合わせ</b><br>
<br>
はい。②のオートリクエストモードしか選択肢ありませんね。(REQ2が使えませんので)<br>
残念ですね～。。。拡張スロットから線を伸ばし、指でスイッチを押して転送開始してみたかったのですが(ぉ。<br>
<br>
オートリクエストモードを使用する場合、さらに"最大速度"か"限定速度"のどちらかを選ぶ必要があります。<br>
<br>
<b>②-1 最大速度</b><br>
    転送終了までバス(データの通り道)を占有します。<br>
    大量のデータを転送すると、長時間CPUが動けなくなります。<br>
<br>
<b>②-2 限定速度</b><br>
    バスの使用率を調整しながら動作します。<br>
    最大速度より遅いですが、CPUを動作させながら転送できます。<br>
<br>
正直、これに関しては、どちらを選ぶべきなのか判断が付きませんでした。<br>
DMAを使う状況によっても変わるのかも知れません。<br>
<br>
とりあえず"最大速度"を選びます。<br>
理由は、Inside X68000に掲載されているDMAに関するサンプルコードは全て"最大速度"に設定されているからです。<br>
<br>
とりあえず最大速度の設定をして、使っていく内に何か問題が発生した場合は調整します。<br>
<br>
オートリクエストモードが具体的にどのような感じか一度、見てみましょう。<br>
第1話のコードを見て下さい。 DMAC2CH_CCR |= 0x80; と書かれたところがありますね。<br>
CCRは8ビットの幅です。一番右を0ビット目として数え始め、一番左の7ビット目に1が書かれた事になりますね。<br>
<br>
このCCRのビット7が実はSTR(スタートオペレーション)という名前を持ってまして、オートリクエストモードではコレが1になる事が転送開始の合図となります。<br>
<br>
という訳で、設定値を決める際に外部要求転送モードに関わる設定は全て無効側に設定する事になります。<br>
逆にオートリクエストモード(最大速度)に関わる設定は全て有効側に設定する事になります。<br>
<br>

<h3>デバイスポートサイズ</h3>

接続先が8ビットポートなのか、16ビットポートなのかで設定値が変わります。<br>
X68000ではFD,HD,ADPCMは全て8ビットポート、メモリは16ビットポートです。<br>
<br>
今回はチャンネル#2でメモリ→メモリ転送しかしないので通常16ビットポートに設定します。<br>
しかし、256色や16色モードのグラフィック画面など上位ビットが無意味なときは、8ビットポートに設定するのもアリです。<br>
関数化する際に16ビットポート固定でも良いですが、お好みで引数により設定できるようにしても良いですね。<br>
<br>

<h3>転送ブロック数</h3>

1ブロックの転送か、複数ブロックの転送かを選んで設定する必要があります。<br>
<br>
書籍とか資料見てると、まず「"ブロック"って何ぞや？？」ってなる訳ですが、弄っている内に理解できました。<br>
1ブロックは、「ある先頭アドレスから連続してアドレスがつながっている1つの塊」です。<br>
要は"配列"の状態ですね。<br>
<br>
C言語で言うと、例えば以下のように定義したとして。。。<br>

<pre>unsigned char hoge[10];
unsigned char fuga[10];
unsigned char piyo[10];
</pre>

ここで、hogeだけを転送した場合は、1ブロックの転送になります。<br>
hogeとpiyoを転送した場合は、2ブロック(複数ブロック)の転送になります。<br>
<br>
ん？hogeとfugaを転送したい場合は？って思われるかもですね。<br>
本題から反れますが、C言語的にこの書き方だとhoge[9]とfuga[0]のアドレスが連続してそうで、例として適切じゃないかなーと思いまして(環境依存で連続しない事もあるかも？)。<br>
<br>
さて本題に戻りまして、今回は1ブロックの転送のみ扱う事にします。<br>
<br>
理由は、現状で僕が複数ブロック転送したい状況が無いからです。<br>
また気が向いたら、そのうち複数ブロック転送に関する投稿をするかもです。<br>
<br>

<h3>転送サイズと転送回数</h3>

第1話のコードを見て下さい。<br>
この例ではunsigned char型の配列を転送しているので転送サイズは8ビットにしています。<br>
これが、例えばunsigned short型の配列の場合は転送サイズを16ビットに設定する訳ですね。<br>
<br>
転送元アドレスと転送先アドレスを格納しているMARとDARのアドレスを定義している#define文を見て下さい。<br>
マクロ側をvoid**型にキャストしていますね。<br>
これは、この先に関数の引数になったとき、何型アドレスでも入るようにするための前兆ですね。<br>
ハードウェアとして生まれたDMAC側からすれば、C言語が思い描いた"型"という概念は理解できないはずです。<br>
そんな彼に転送サイズとして指示を出してあげましょう。<br>
<br>
転送回数は、前回に弄っていますし、説明不要ですね。(たぶん)<br>
<br>
今回、DMACに対する設定値は、転送サイズも転送回数も関数化した上で引数にするのが良さそうですね。<br>
<br>

<h3>スーパーバイザ</h3>

X68000におけるメモリ空間へのアクセスは、ユーザーモードとスーパーバイザモードの2種類があります。<br>
通常はユーザーモードになっており、一部のメモリ空間にはアクセスできないよう制限がかかっています。<br>
要は安全装置なのですが、不自由な時もあるので時としてスーパーバイザモードにしてやる訳です。<br>
<br>
第1話のコードを見て下さい。main()が始まってすぐに int ssp = B_SUPER(0); とありますね。これでスーパーバイザモードに切り替わりました。<br>
そしてmain()の最後で B_SUPER(ssp); としていますね。これでユーザーモードに戻りました。<br>
何でこんな事しているのかと言うと、DMACのレジスタも保護されていて、ユーザーモードのまま触るとバスエラーになってしまうからです。<br>
<br>
自前のプログラムからのアクセスでは、B_SUPER()を呼ぶ訳ですが、"DMACが" 保護された領域に触る事も多そうですよね。<br>
大丈夫です、DMACにもユーザーモードか、スーパーバイザモードかを設定する場所があります。<br>
<br>
と言う訳で、この先DMA転送でVRAMとか触る事が多そうですし設定はスーパーバイザモードで固定にします。<br>
<br>

<h3>今回決めた設定方針のまとめ</h3>

・チャンネル#2を使用<br>
・メモリ→メモリ転送のみ行う<br>
・デュアルアドレスモード<br>
・ピンは一切使わない<br>
・オートリクエストモード(最大速度)<br>
・デバイスポートサイズは16ビットポート(お好みで引数化)<br>
・1ブロックの転送のみ行う<br>
・転送サイズと転送回数は引数にする<br>
・スーパーバイザモード<br>
<br>

<h3>次回予告</h3>
次回は、各レジスタと各ビットの詳細を確認していきます。<br>
今回決めた方針に基づき、各レジスタへの具体的な設定値を決めていきましょう。<br>
<br>

<h3>Link</h3>
・<a href="../DMA_1_Z940/DMA_1_Z940.html">第1話 はこちら</a><br>
・<a href="../DMA_2_Z953/DMA_2_Z953.html">第2話 はこちら</a><br>
・<a href="../DMA_3_Z976/DMA_3_Z976.html">第3話 はこちら</a><font style="color: #ffd700;"> ← NEXT</font><br>
・<a href="../DMA_4_Z1002/DMA_4_Z1002.html">第4話 はこちら</a><br>
・<a href="../DMA_5_Z1040/DMA_5_Z1040.html">第5話 はこちら</a><br>
<br>

<hr>

<h3>Archive Note</h3>
こちらは X68000 Z コミュニティサイト(Z-CLUB) 過去投稿を修正加筆したものです。<br>
基本的に当時の状況に基づいた内容になっています。<br>
元投稿：<a href="https://dev.zuiki.com/project-z/community/post/detail/953">https://dev.zuiki.com/project-z/community/post/detail/953</a><br>
<br>
<br>
<br>
<!-- (C)表記をしない方針とするものの、テキストの終端は明示する-->
<div style="color: #00ff83;">[EOF]</div>
</body>
</html>